# Generate shape files for plot segmentation in QGis 

1. Open QGIS. In the CRS window (Coordinate Reference System ; click on the bottom right of the screen <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image1.png?raw=true" alt="Figure 1"/>
to display it), check ‘Enable ‘on the fly’ CRS transformation (OTF)’. Afterwards, choose the UTM (Universal Transverse Mercator) CRS of your studied area. You can find a map <a href='http://www.dmap.co.uk/utmworld.htm' target='_blank'>here</a>. For example, Tokyo is in UTM 54N.
Optional : Make selection color transparent by reducing opacity in Set Selection Color window (Settings menu > Options > Canvas & Legend > click on Selection color, reduce the opacity with your mouse). It is best not to put 0% of opacity but rather something like 10%.<br/>
<img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image2.png?raw=true" alt="Figure 2"/><br/>
2. Open the file of the crop by clicking ‘add raster layer’ button <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image3.png?raw=true" alt="Figure 3"/>
3. Go to the top of the window and choose ‘Layer’ > ‘create layer’ > ‘new shapefile layer’ (or Shift + ctrl + N)
4. In the new window, select ‘Polygon’. The CRS (Coordinate Reference system) should automatically be the same as the raster you imported before but otherwise you can click on the drop down menu and choose ‘Project CRS’ (followed by the said CRS). Click ‘ok’.
5. A new window opened. You can choose where you would like the .shp file of the whole field to be saved.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image4.png?raw=true" alt="Figure 4"/>
6. Back into QGIS main window, click the yellow pen on the top left-hand corner of the screen, named ‘Toggle Editing' <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image5.png?raw=true" alt="Figure 5"/>
7. Click on the ‘Add feature’ button <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image6.png?raw=true" alt="Figure 6"/>, which should now be colored.
8. Click on the picture with the left button of your mouse to draw a rectangle that covers all the observed field. Once you are done, click the right button. If you want to edit what you drew, you can do it afterwards with the ‘Advanced Digitizing Toolbar’ (View > Toolbars > Advanced Digitizing Toolbar).<br/>,img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image7.png?raw=true" alt="Figure 7"/>
9. If you want to see through the shape, double click on the file name on the bottom left-hand corner of the window. A new window opened ; go to ‘Style’, click on ‘Color’ and set the opacity to 0. Click ‘Apply’ then ‘ok’ at the bottom of the window.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image8.1.png?raw=true" alt="Figure 8"/><br/>
Optional : you can also change the outline color by clicking on : ‘Simple Fill’ > ‘Outline’ then select the color. You can change other features as well, such as the style or the width of the outline.
10. Then, use the toolbox (if not displayed, click on ‘View’ > ‘panel’ > ‘toolbox’) and search for ‘Oriented Minimum Bounding Box’ (QGIS geoalgorithms > Vector general tools > Oriented minimum bounding box). Double click on it. A new window opens ; choose the whole field file in the input layer. Press ‘Run’.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image9.png?raw=true" alt="Figure 9"/>
11. With the newly created layer, probably called ‘Oriented_MBBox’, you can find the angle of the rectangle in the attribute table (right click > attribute table).<br/> If you want the value to be displayed at any time, you can click on View > Panel > Statistic Panel. A new window should have open on the left side of the screen. Select the layer ‘Oriented_MBBox’ and ‘angle’.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image10.png?raw=true" alt="Figure 10"/><br/><em>Attribute table of the Oriented Minimum Bounding Box</em><br/>The value displayed is the angle compared to the North direction. Write it down somewhere or remember the value (or keep it on your screen).
12. Use the rotate feature (in edit mode) to change the polygon angle to horizontal.<br/>If the feature is not displayed on the top of the screen, you can display it in View > Toolbars > Advanced Digitizing Toolbar.<br/>You need to be in edit mode to use the feature (click on the yellow pen <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image5.png?raw=true" alt="Figure 11"/>).<br/>
Click on the feature <img src ="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image11.png?raw=true" alt="Figure 12"/>, then click on the ‘Oriented_MBBox’ rectangle in the screen. A window should open on the top-left hand corner of your screen. Put the angle you saved before in the ‘rotation’ section (do not forget the minus sign if needed). Click ‘ok’ or press enter. Quit the edit mode and save the changes.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image12.1.png?raw=true" alt="Figure 13"/>
13. In the processing toolbox, search for ‘Vector grid’ (QGIS geoalgorithms > Vector creation tools > Vector Grid). Double click it. For the grid extent, click on the three dots at the end of the line and chose ‘Select extent on canvas’. You can now select the rectangle area with your mouse on the main screen, using the ‘Oriented_MBBox’ as a pattern.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image12.png?raw=true" alt="Figure 14"/><br/><br/>
<b>If you know the distance between the rows and columns of your plot, do as follow :</b>
* For X spacing, put the average width of a row in meters<br/>
* For Y spacing, put the average height of the number of rows you want in a cell, in meters<br/>
<u>Do not forget to add the margin/padding in both cases.</u><br/><br/>
If you do not know the distance, you can also measure the needed distance with the feature ‘Measure Line’ (Ctrl+Shift+M or this icon <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image13.png?raw=true" alt="Figure 15"/> at the top of the screen, be sure that ‘Measure Line’ is the selected choice). Measure more than just the distance between rows as the distances used will be the width and height of the table cells.<br/><br/><b>Otherwise, you can do as follow but <u>it is not recommended :</u></b>
* For X spacing, click on the three points at the end of the line and type : <br/><ul>(@Oriented_MBBox_maxx - @Oriented_MBBox_minx ) / <em>columns_number</em></ul>
* For Y spacing, click on … and type :<br/><ul>(@Oriented_MBBox_maxy - @Oriented_MBBox_miny ) / <em>rows_number</em></ul><br/>
Replace <em>column_number</em> and <em>rows_number</em> by a real whole number.<br/>
The grid type should be ‘Output grid as polygons’. Check the box ‘open output file after running algorithm’ if it is not already done. Click ‘Run’.<br/><br/>
<b>Sometimes, too many columns or rows are issued</b>. You can erase them by doing as follow : go in edit mode, use ‘Select feature(s)’, select the unwanted grid (left click + ctrl) and hit ‘delete’ on your keyboard.<br/>If you want the gid to have a transparent background, double click on the grid’s name. In the ‘style’ menu, click on ‘color’ and put the opacity to zero.<br/>Go in edit mode, select all the polygone of the grid rectangle (on the top of the screen, select feature(s)) and use the rotate feature to put the grid back into the right angle (angle input = - previous angle) or do it with your eyes. If you want to move the grid, you can use the ‘Move Feature’ tool <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image14.png?raw=true" alt="Figure 16"/> (left click and drag the grid to reposition it more precisely ; you can help yourself by displaying the rectangle of the whole shape made in the first place).  Quit edit mode (and save).
14. Go in the attribute table (right click > attribute table), enter the edit mode, add a new column *<img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image15.png?raw=true" alt="Figure 17"/> and call it ‘PLOT’. The type should be ‘whole number’. Click ok. Then, on the top of the window, click on the spinning box under the yellow pen and select ‘PLOT’. Afterwards, write in the blank space next to the omega sign :  <ul>@row_number </ul><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image16.png?raw=true" alt="Figure 18"/><br/>
Click then on the ‘Update all’ at the end of the line. If you erase other columns or rows in between, redo the ‘Update all’ step. You should have numbers that follow each other. Quit edit mode (save the changes).<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image17.png?raw=true" alt="Figure 19"/>
15. Double click on the grid name. Go to the ‘label’ section. On the top of the window, select ‘Show label for this layer’, then select ‘PLOT’ for ‘Label with’. Click ‘apply’ and then ‘ok’. <br/> <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image18.png?raw=true" alt="Figure 20"/> <br/>You should end up with something like this :<br/> <img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image19.png?raw=true" alt="Figure 21"/>
16. To save the grid, right-click on its name and select ‘save as’ and choose *.shp (ESRI ShapeFile). The labels will be off next time you use the file but you can replace them when needed if it is an ESRI ShapeFile (the ‘PLOT’ attribute will remain the same).<br/>You can save all the layers using File > Save as. The generated file in that case will be *.qgs (QGIS project).<br/>To get every plot individually (which is the point of all this), find 'Split Vector Layer' (Processing Toolbox > QGIS geoalgorithms > Vector general tools > Split Vector Layer). Select the grid in the 'Input Layer', 'PLOT' in the 'Unique ID Field' and the directory in which you want to save the files in 'Output directory'. Creating a new folder where to put all those files is recommended. Click on 'Run'.<br/><img src="https://github.com/oceam/UAVPP/blob/master/image/gen_shp_qgis/image20.png?raw=true" alt="Figure 22"/><br/>
You should have all the plot files (.shp) in the directory you chose !